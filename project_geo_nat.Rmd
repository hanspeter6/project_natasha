---
title: "Soil Characteristics and Burn"
author: "Hans-Peter Bakker (BKKHAN001)"
date: "6/1/2018"
output:
  html_document: default
  pdf_document: default
  word_document: default
bibliography: natasha.bib
---
---
nocite: |
        @rpart, @rpart.plot, @dplyr, @FactoMineR, @factoextra, @caret, @brglm, @corrplot, @mice, @glmnet, @RStudio
...


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, error = FALSE)
```

# ```{r}
# ## extract the bibtex entry from the return value
# x <- citation("caret")
# toBibtex(x)
# ```


```{r}
# libraries:
library(dplyr)
library(FactoMineR)
library(factoextra)
library(rpart)
library(rpart.plot)
library(caret)
# library(logistf)
library(brglm)
library(corrplot)
library(mice)
```

```{r}
# read .csv file:
geo_data <- read.table("trial2.csv",
                       header = TRUE, sep = ";")
```
##Data Cleaning and Initial Exploration

After first abbreviating or shortening some of variable names and some of the category labels, the provided Excel spreadsheet was read in as a .csv file.

The variables *site*, *type* and *burn* were converted to factor variables.

A summary of the variables is shown below and reflects missing values for *hsv* and for *hp*.

```{r}
#change site, type, burn to factor variables
geo_data$site <- factor(geo_data$site)
geo_data$type <- factor(geo_data$type)
geo_data$burn <- factor(geo_data$burn, labels = c("No Burn", "Burn"))

summary(geo_data)
```

```{r}
# numeric dataset
geo_data_nums <- data.frame(scale(geo_data[,c('elevation',
                                              'slope',
                                              'hsv', # 3 NA's
                                              'hp',
                                              'moisture',
                                              'ph',
                                              'loss_ig',
                                              'sand',
                                              # 'silt', # due to singularity
                                              'clay')]))

```

The missing values were replaced by imputed values that were based on the medians of the respective variables. (GET BACK TO THIS!!)

```{r}
# impute missing values: multivariate imputations by chained equations (mice)
# which rows (hp row 35; hsv rows 35,64 & 79 )
imputed <- mice(geo_data, print = FALSE)
# imputed$imp$hsv
# imputed$imp$hp
#pool(imputed)
```

Finally, given the linear dependence between between *silt*, *clay* and *sand* (they add up to 100%), *silt* was dropped from the dataset.

### Correlation Matrix

A plot indicating the correlations between the numeric variables is shown below (and a .jpeg file for publication was generated).

```{r}
# consider correlations
cor_mat <- cor(geo_data_nums, use = 'pairwise.complete.obs')
corrplot(cor_mat, method = 'pie', tl.col = "black")
jpeg("corrplot1_geo.jpeg")
corrplot(cor_mat, method = 'pie', tl.col = "black")
dev.off()
```

The strong correlation between *moisture* and *loss_ig* would suggest that only one of these is required. The relatively strong negative correlation between *sand* and *clay* can also be expected due to the fact that a high percentage of the one automatically implies a low percentage of the other.

The generally high levels of correlation would suggest that dimension reduction may be worth considering, although it may  be accompanied by more difficult interpretations.

### Principal Components Analysis

To examine the latent dimensionality of the numerical data, principal components analysis was done on the standardised numeric variables. The scree plot below suggests an *elbow* at four components. The summary output shows that a cumulative 86% of the variance would be captured by the first four components. (a .jpeg file of the screeplot is also generated)

```{r}
# to explore dimensionality of numerical variables for now only complete cases
pca_geo <- princomp(geo_data_nums[complete.cases(geo_data_nums),])
screeplot(pca_geo, type = "lines", main = "Scree Plot of Principal Components", npcs = 8)
abline(v = 4, lty = 2)
# for printing:
jpeg("pca_screeplot.jpeg")
screeplot(pca_geo, type = "lines", main = "Scree Plot of Principal Components", npcs = 8)
abline(v = 4, lty = 2)
dev.off()

summary(pca_geo)
```

The vector plots below (which are also reproduced in .jpeg files) give some idea of the contributions of variables on the four dimensions. These could be used to interpret the meaning of the components/factors.

Although this approach may be interesting as a point of discussion on how the variables relate to each other, taking this approach further would more likely lead to greater difficulties in the interpretation of outcomes and effects, but if required, this approach of working with latent constructs can be pursued.

```{r}
# using factomineR
pca_geo_factoMineR <- PCA(geo_data_nums[complete.cases(geo_data_nums),], ncp = 4, graph = FALSE)

fviz_pca_var(pca_geo_factoMineR,
             axes = c(1,2),
             col.var="contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             title = "Dimensions 1 & 2",
             repel = TRUE # Avoid text overlapping
)

jpeg("contributions_pca_1n2.jpeg")
fviz_pca_var(pca_geo_factoMineR,
             axes = c(1,2),
             col.var="contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             title = "Dimensions 1 & 2",
             repel = TRUE # Avoid text overlapping
)
dev.off()

fviz_pca_var(pca_geo_factoMineR,
             axes = c(3,4),
             col.var="contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             title = "Dimensions 3 & 4",
             repel = TRUE # Avoid text overlapping
)

jpeg("contributions_pca_3n4.jpeg")
fviz_pca_var(pca_geo_factoMineR,
             axes = c(3,4),
             col.var="contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             title = "Dimensions 3 & 4",
             repel = TRUE # Avoid text overlapping
)
dev.off()

```
## Partition Tree

To offer some initial exploration of the link between the variables and the outcome (*Burn* or *No Burn*), a simple partition exercise (or *tree*) was considered with all the variables - numeric and categorical - as response variables. Only the adjusted (reduced levels) categorical variables were used. Two 

plots showing the first four levels are shown below. (and also added as a further .jpeg file for use in publication). In the second plot, the variable *colour* was removed.

```{r}
# consider classification tree for explanatory reasons:
tree_geo1 <- rpart(burn ~ 
                          area2 +
                          geology2 +
                          aspect2 +
                          veg +
                          elevation +
                          slope +
                          hsv +
                          hp +
                          moisture +
                          ph +
                          loss_ig +
                          colour +
                          sand +
                          silt +
                          clay
                          ,
                  data = geo_data)

tree_geo2 <- rpart(burn ~ 
                          area2 +
                          geology2 +
                          aspect2 +
                          veg +
                          elevation +
                          slope +
                          hsv +
                          hp +
                          moisture +
                          ph +
                          loss_ig +
                          # colour +
                          sand +
                          silt +
                          clay
                          ,
                  data = geo_data)
```

```{r}

# all variables
rpart.plot(tree_geo1, type = 4, extra = 1, cex = 0.8, main = "Burn Partition: All Variables")

jpeg("partition_tree1.jpeg")
rpart.plot(tree_geo1, type = 4, extra = 1, cex = 0.8, main = "Burn Partition: All Variables")
dev.off()

# minus 'colour'
rpart.plot(tree_geo2, type = 4, extra = 1, cex = 0.8, main = "Burn Partition: Minus *colour*")

jpeg("partition_tree2.jpeg")
rpart.plot(tree_geo2, type = 4, extra = 1, cex = 0.8, main = "Burn Partition: Minus *colour*")
dev.off()

```

The predictive power of the second partitioning model (without *colour*), which showed higher levels of accuracy than the full set, using the existing data as predictors suggests relatively high levels of accuracy - as can be seen in the confusion matrix and relevant statistics shown below. If the purpose of this project was prediction, this line of investigation could be pursued into considering random forests and other methods.

```{r}
# consider prediction power of single tree:
pred_class <- predict(tree_geo2, type = "class")
confusionMatrix(data = pred_class, reference = geo_data$burn)
```

## Logistic Regression 

Given the binomial nature of the outcome variable, logistic regression was considered to quantify the relative importance of predictor variables on the class of outcome.

Initial attempts were thwarted due to the fact that the data appeared to be perfectly separable. This meant that the standard estimating methods (Fisher's Scoring) could not be applied. An alternative, *bias reduction*, method proposed by Firth (1993) was adopted. Although this method may not offer entirely unbiased results, the estimates are finite and compare well with more established estimating procedures.
 
After considering various alternative models (more details here if you like), the summary output below reflects the final, suggested model for these data. 

The use of Akaike’s information criterion (AIC) for model selection when method = "brglm.fit" is controversial. AIC was developed under the assumptions that (i) estimation is by maximum likelihood and (ii) that estimation is carried out in a parametric family of distributions that contains the “true” model. At least the first assumption is not valid when using method = "brglm.fit". However, since the MLE is asymptotically unbiased, asymptotically the modified-scores approach is equivalent to maximum likelihood. A more appropriate information criterion seems to be Konishi’s generalized information criterion (see Konishi & Kitagawa, 1996, Sections 3.2 and 3.3), which will be implemented in a future version.



```{r eval = FALSE}
# Logistic regression (first round shows up perfect separation...)
lr_geo <- glm(burn ~ area2 +
                      geology2 +
                      aspect2 +
                      veg +
                      elevation +
                      slope +
                      hsv +
                      hp +
                      moisture +
                      ph +
                      loss_ig +
                      colour +
                      sand +
                      clay,
              data = geo_data,
              family = "binomial")

```

```{r}
alt_mod <- brglm(burn ~
                         area2 +
                         geology2 +
                         aspect2 +
                         veg +
                         elevation +
                         slope +
                         hsv +
                         hp +
                         moisture +
                         ph +
                         loss_ig +
                         colour +
                         sand +
                         clay,
                 data = geo_data,
                 family = "binomial")

summary(alt_mod)
```

#### Please note:
*The interpretation of the estimated coefficients needs to consider the logistic nature of these estimating procedures. Please don't hesitate to ask for help*

```{r eval = FALSE}
#consider stepwise approaches to consider "best" models: 
library(glmnet)

# getting model.matrix
mat_mod <- model.matrix(burn ~ area2 +
                                geology2 +
                                aspect2 +
                                elevation +
                                slope +
                                hsv +
                                hp +
                                moisture +
                                ph +
                                loss_ig +
                                colour +
                                sand +
                                silt,
                        data = geo_data)

# find out NA rows
which(is.na(rowSums(geo_data_nums)))
net_mod <- glmnet(x = mat_mod[,-1], y = geo_data$burn[-c(35,64,79)],
                   family = "binomial")

plot(net_mod, label = TRUE)
summary(net_mod)
# 
```

# References
